# API

## 주요 변경점
- Popup 의 변경 (Network, Wallet 추가 / 삭제) 를 실시간으로 Web App 에 반영
  - Rx Observable 기반의 저수준 API 와 React Hook 지원
- 기존 Popup 을 열어서 처리하던 동작들을 iframe 형태로 전환 (Web App 내부에 통합)
- 지원 Browser 확대 (Sarari >= 14, Chrome >= 70, Firefox >= 80)
- Disconnect / Connect 없이 여러개의 Wallet을 동시 연결

# 설치 및 기본 설정

## 설치

```sh
yarn add @terra-dev/terra-connect @terra-dev/terra-connect-webextension @terra-dev/terra-connect-react
```

## 기본 설정

```html
<html>
  <head>
    <meta name="terra-connect" />
  </head>
</html>
```

WebExtension은 Website 내의 `<meta name="terra-connect" />`가 있는 경우에만 초기화 동작을 한다.

(WebExtension이 모든 Website를 대상으로 동작하기 때문에 대상이 아닌 Website를 배제할 방법이 필요)

# `new TerraConnectWebExtensionClient(Window)`

## 생성

```js
// Interface
import { TerraConnectClient } from '@terra-dev/terra-connect'
// Implementation
import { TerraConnectWebExtensionClient } from '@terra-dev/terra-connect-webextension'

const client: TerraConnectClient = new TerraConnectWebExtensionClient(window)
```

## `client.status() => Observable(StatusInitializing | StatusNoAvailable | StatusReady)`

현재 Client 의 동작 상태를 (사용 불가, 설치 되지 않음, 준비 됨...) 알 수 있다.

```js
client.status().subscribe(status => {
  console.log('Status', status)
})
```

## `client.clientStates() => Observable({ networks: WalletInfo[], network: Network } | null)`

WebExtension에 등록되어 있는 Wallet들과 선택된 Network 를 받을 수 있다.

```js
client.clientStates().subscribe(clientStates => {
  if (clientStates) {
    console.log('Network is', clientStates.network)
    console.log('Wallets are', clientStates.wallets)
  } else {
    console.log('Waiting clientStates...')
  }
})
```

## `client.execute({ terraAddress: string, network: Network, tx: Tx }) => Observable(TxProgress | TxSucceed | TxFail | TxDenied)`

WebExtension에 Transaction을 요청한다.

```js
// Anchor deposit 10 USD
const tx = {
  fee: new StdFee(
    6000000, // gasFee
    new Coins({
      uusd: '1000000'
    })
  ),
  gasAdjustment,
  msgs: [
    new MsgExecuteContract(
      'terra12hnhh5vtyg5juqnzm43970nh4fw42pt27nw9g9',
      'terra15dwd5mj8v59wpj0wvt233mf5efdff808c5tkal',
      {
        deposit_stable: {}
      },
      new Coins({
        uusd: new Int(10 * 1000000).toString()
      }),
    )
  ]
};

client.execute({
  tx,
  network: clientStates.network,
  terraAddress: 'terra12hnhh5vtyg5juqnzm43970nh4fw42pt27nw9g9'
}).subscribe({
  // 진행 상태, 결과를 Rx Observable 로 지속적으로 받는다
  next: result => {
    switch (result.status) {
      case TxStatus.PROGRESS:
        console.log('In Progress...')
        break
      case TxStatus.SUCCEED:
        console.log('Succeed!', result.payload)
        break
      case TxStatus.FAIL:
        console.log('Fail!', result.error)
        break
      case TxStatus.DENIED:
        console.log('User Denied!')
        break
    }
  },
  // 진행 중 에러가 나는 경우
  error: (error) => {
    console.log('Transaction failed!', error)
  },
  // 모든 진행이 완료되었을 경우 (Teardown logic 등이 필요할때)
  complete: () => {
    console.log('Transaction is done!')
  }
})
```

# `<TerraConnectProvider client={TerraConnectClient}>`

React 내에서 Rx Observable 을 직접 사용하는 대신 React Hook 형태로 사용할 수 있다.

(Apollo GraphQL의 `ApolloClient` 와 `useQuery()` 의 관계와 비슷)

```jsx
// Interface
import { TerraConnectClient } from '@terra-dev/terra-connect'
// Implementation
import { TerraConnectWebExtensionClient } from '@terra-dev/terra-connect-webextension'
// Reactify
import { TerraConnectProvider } from '@terra-dev/terra-connect-react'

const client: TerraConnectClient = new TerraConnectWebExtensionClient(window)

function Main() {
  return (
    <TerraConnectProvider client={client}>
      <MyApp />
    </TerraConnectProvider>
  )
}
```

위와 같이 일반적인 React Context Provider 설정을 한 뒤,

```jsx
import { useTerraConnect } from '@terra-dev/terra-connect-react'

function SomePage() {
  const { clientStates } = useTerraConnect()

  if (!clientStates) {
    return null
  }

  return (
    <ul>
      <li>Network is {JSON.stringify(clientStates.network)}</li>
      <li>Wallets are {JSON.stringify(clientStates.wallets)}</li>
    </ul>
  )
}
```

# `<WalletSelectProvider>`

`TerraConnectClient` 는 WebExtension 내에 존재하는 모든 Wallet 들을 보내준다.

App 내에서 하나의 지갑만으로 선택 사용해야 할 경우를 위한 보조 도구.

```jsx
import { TerraConnectClient } from '@terra-dev/terra-connect'
import { TerraConnectWebExtensionClient } from '@terra-dev/terra-connect-webextension'
import { TerraConnectProvider, WalletSelectProvider } from '@terra-dev/terra-connect-react'

const client: TerraConnectClient = new TerraConnectWebExtensionClient(window)

function Main() {
  return (
    <TerraConnectProvider client={client}>
      <WalletSelectProvider>
        <MyApp />
      </WalletSelectProvider>
    </TerraConnectProvider>
  )
}
```

위와 같이 설정하고,

```jsx
function SomePage() {
  const { selectedWallet, selectWallet, wallets } = useWalletSelect()

  return (
    <ul>
      {
        wallets.map(itemWallet => (
          <li key={itemWallet.name}>
            <div onClick={() => selectWallet(itemWallet)}>
              <span>[{selectedWallet.name === itemWallet.name ? '선택됨' : '선택되지 않음'}]</span>
              <span>{itemWallet.name} ({itemWallet.terraAddress})</span>
            </div>
          </li>
        ))
      }
    </ul>
  )
}
```

위와 같이 구성할 수 있다.

# 아직 해결되지 않은 문제들

- [ ] 기존 Chrome Extension 에서 Migration 을 어떻게 할 것인가?
- [ ] 여러 지갑들 중에 하나의 지갑을 선택하는 선택권을 Web 으로 넘길 것 인가? VS Extension 내의 선택을 강요할 것인가?
    - 후자의 경우 (Many : 여러 Web App) x (WebExtension) 상황에서의 동기화 문제가 발생
- [ ] Ledger 는 무엇인가?